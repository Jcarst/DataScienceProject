---
title: "DS325 Project 3: Recidivism"
author: "Johnny Carstens & Matthew Bushnell"
date: "12/2/2021"
output:
  html_document:
    theme: spacelab
    highlight: haddock
    toc: true
    toc_float: true
    number_sections: false
    code_folding: hide
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=TRUE, message=FALSE, warning=FALSE)
```


# Introduction
For this project, we are analyzing a criminal justice data set to accurately model and predict recidivism (the likelihood a criminal will reoffend). The data set we are using for these models is from Broward County, Florida and also contains recidivity risk and violence risk scores from a tests that the criminals were given. We will build a model with and a model without those scores to determine how helpful the tests really are in predicting recidivity. 

Not only will we be creating models on our data set to predict recidivity, we will also be exploring the implications and morality of using algorithms in the criminal justice system. 

# Logistic Regression of Recidivism Data

```{r trapAnthem}
library(tidyverse)
library(olsrr)
library(ggfortify)
library(GGally)
library(mdsr)
data <- read.csv("Project3Sample4000.csv")

pairs <- data %>% select(!c(name,dob, c_jail_in, c_jail_out, RiskRecidScreeningDate,c_charge_desc))

Originaldata <- read.csv("Project3Sample4000.csv")

############### Matt's code
data <- Originaldata %>%
  separate(c_jail_in, c("inDay","inMonth","inYear")) %>%
  separate(c_jail_out,c("outDay","outMonth","outYear")) %>%
  mutate(
    daysInJail = ((as.integer(outYear)*365)+(as.integer(outMonth)*30)+(as.integer(outDay)))-((as.integer(inYear)*365)+(as.integer(inMonth)*30)+(as.integer(inDay)))
  ) %>%
  select(!c(name, dob, inDay, inMonth, inYear, outDay, outMonth, outYear, RiskRecidScreeningDate, c_charge_desc)) %>%
  mutate(
    crimeType = str_extract(c_charge_degree,"[MF]")
  ) %>%
  filter(
    !is.na(crimeType)
  ) %>%
  select(!c(RiskViolenceDecileScore,crimeType,c_charge_degree,race,juvFelonyCount,juvMisdemeanerCount,juvOtherCount,ageCat,days_b_screening_arrest,c_days_from_compas,RiskRecidScoreLevel,RiskViolenceScoreLevel))


ggplot(pairs, aes(x = age, fill = as.factor(isRecid))) + 
  geom_density(alpha=.3) + 
  labs(x = "Age", y = "Density", title = "Figure 1: Density of Age", fill="Reoffended")
```

Figure 1 is a density plot of Age vs Reoffenders. Reoffend is a binary response variable where 1 is equal to a person who did reoffend, and 0 is equal to someone who hasn't reoffended. Notice that in Figure 1, as age increases the amount of people who reoffended, or didn't reoffend decreases. We can also see that between ages 30 and 35, the amount of people who didn't recidivate becomes greater than those who did recidivate. It makes sense to see older individuals become less inclined towards reoffending while younger individuals have a greater inclination towards reoffending. Perhaps one of the reasons why older individuals are less inclined to reoffending is because of extensive time spent in incarceration. Age looks like a good variable to use in our model.

```{r jPop}
ggplot(pairs, aes(x=priorsCount, fill=as.factor(isRecid))) + 
  geom_density(alpha=.3) + 
  labs(x="Number of Prior Convictions", y = "Density", title = "Figure 2: Density of Prior Convictions.", fill = "Reoffended")
```

Figure 2 is a density plot of the number of prior convictions who did and did not recidivate. It is clear that those who have never committed a prior crime are much less likely to reoffend. This data is fairly skewed, so we apply the natural log function to the number of prior convictions which brings us to the next plot. 

```{r Dragostea Din Tei}
ggplot(pairs, aes(x=log(priorsCount+0.1), fill=as.factor(isRecid))) + 
  geom_density(alpha=.3) + 
  labs(x="Logarithm of Prior Convictions", y = "Density", title = "Figure 3: Density of ln(Prior Convictions)", fill = "Reoffended")
```

Figure 3 is the same plot as figure 2, except we added 0.1 to the number of prior convictions and then applied a natural logarithm to the data column. We can see that the distribution has been normalized better compared to Figure 2. We shall use this process of using the natural logarithm when building our logistic regression model. The peak on the left side of the data represents individuals who had 0 prior convictions while the next bump over the valley represents those who had 1 or more. The reason for the valley in between is because of the nature of logarithms and the fact that we had to add 0.1 to the values of 0 in order to get defined numbers. We can see that individuals who had 1 prior were slightly less likely to reoffend while those with more than 1 greatly increased their recidivity risk.

```{r I cant remember if we wanted to include this one}
ggplot(pairs, aes(x=sex, fill = as.factor(isRecid))) + geom_bar(position = "dodge") + 
  labs(x = "Sex", y = "Count", title = "Figure 4: isRecid vs Sex",fill="Reoffended")
```

Figure 4 is a bar graph of Sex vs Reoffended. First we note that the male category is much larger. This plot also shows that less than a third of females are likely to reoffend while greater than a third of men are likely to reoffend. This information can be useful to our model.

```{r}
ggplot(data=data,aes(x=log(daysInJail+.1),fill=as.factor(isRecid))) +
  geom_density(alpha=.3) +
  labs(x="Natural Log of Days spent in jail",y="Density",fill="Reoffended",title="Figure 5: Density of days spent in jail")
```

Figure 5 is a density plot of the logarithm of days spent in jail colored by those who reoffended and those who did not. The reason we used the logarithm for this plot is because it was difficult to visualize otherwise, we will not be using the logarithm for our model because it proved to reduce the accuracy of our model.


# Building Logistic Regession Models for Classification
The data set provided contained a variable called RiskRecidDecileScore. This score came from convicts taking a test that determined how likey they are to recidivate on a scale of 1-10. We built one model that includes the RiskRecidDecileScore and one model without the score. 
The first model we built does not include RiskRecidDecileScore in our prediction variables. 

```{r Metallica, results='fold'}
modelNSdata <- data %>% select(!RiskRecidDecileScore)
modelNS <- glm(data=modelNSdata,isRecid~sex+age+daysInJail+log(priorsCount+.1),family="binomial")
```

### Model with no scores{.tabset}
#### Simple

|Variable|Value|
|:-|:-|
|Intercept|`r modelNS[[1]][1]`|
|Sex=Male|`r modelNS[[1]][2]`|
|Age|`r modelNS[[1]][3]`|
|Days In Jail|`r modelNS[[1]][4]`|
|Natural Log of Priors|`r modelNS[[1]][5]`|

#### Full Summary
```{r}
summary(modelNS)
```

### {-}

Above is a summary of the logistic model created to predict whether or not a convict will recidivate. If we check the full summery tab we can see that all of our variables are statistically significant. 

Johnny explain here because I can't

```{r matt is being confusing}
modelNSPred <- predict.glm(modelNS,newdata=data,type="response")


dataWNSPred  <- cbind(data,modelNSPred)

dataWNSPred <- dataWNSPred %>%
  mutate(
    recidPred = ifelse(modelNSPred > .5, 1, 0)
  )

WNSmatrix <- table(dataWNSPred$recidPred,dataWNSPred$isRecid)
```

|||||
|-|-|-|-|
|||Predicted|Predicted|
|||Didn't Reoffend|Reoffended|
|Actual|Didn't Reoffend|`r WNSmatrix[1]`|`r WNSmatrix[3]`|
|Actual|Reoffended|`r WNSmatrix[2]`|`r WNSmatrix[4]`|

The output above shows our confusion matrix for our logistic model. The first row is the actual number of convicts who didn't recidivate who were predicted to either recidivate or not recidivate. For example, the top left of the matrix is the number of actual convicts who did not recidivate who were predicted to not recidivate, and the top right is the number of convicts who didn't recidivate who were predicted to recidivate. The bottom row is similar except its the number of people who did recidvate and the number of convicts who were predicited to either not recidivate or predicited to recidivate. From this matrix we can calculate our error rate. Error rate is defined as the number of people who didn't recidivate who were predicted to recidivate plus the number of people who did recidivate who were predicted to not recidivate dived by the total number of observations. The mathematical definition is 
$$ 
\textrm{Error Rate} = \frac{CF_{12} + CF_{21}}{n},\textrm{ where i = row, j = column, and n = number of observations.}
$$ 

Using our Error Rate formula and plugging in values from our confusion matrix gives us 
$$
\textrm{Error Rate} = 0.2958979	
$$
Our error rate is the percentage of data points that our model got wrong.

Now we will build a model using the recidivism scores that we were given with the data set. This will help determine if the scores are effective or not.

```{r}
modelWS <- glm(data=data,isRecid~+sex+age+RiskRecidDecileScore+daysInJail+log(priorsCount+.1),family="binomial")
```

### Model with scores{.tabset}
#### Simple

|Variable|Value|
|:-|:-|
|Intercept|`r modelWS[[1]][1]`|
|Sex=Male|`r modelWS[[1]][2]`|
|Age|`r modelWS[[1]][3]`|
|Risk Recid Decile Score|`r modelWS[[1]][4]`|
|Days In Jail|`r modelWS[[1]][5]`|
|Natural Log of Priors|`r modelWS[[1]][6]`|

#### Full Summary
```{r}
summary(modelWS)
```

### {-}

Above is a summary of the logistic model created to predict whether or not a convict will recidivate. If we check the full summery tab we can see that all of our variables are statistically significant.

Johnny explain here because I can't

# Multiple Regression Models

In this section we are trying to predict the scores for recidivism. 

# Classification models for two subpopulations.

Looking at our data from Broward County we can see that there is a much larger amount of males when compared to females. Let us make a classification model for each gender and see how they compare to each other.

```{r}
males <- read.csv("Project3Males1500.csv")
females <- read.csv("Project3Females1500.csv")

fdf <- females %>%
  separate(c_jail_in, c("inDay","inMonth","inYear")) %>%
  separate(c_jail_out,c("outDay","outMonth","outYear")) %>%
  mutate(
    daysInJail = ((as.integer(outYear)*365)+(as.integer(outMonth)*30)+(as.integer(outDay)))-((as.integer(inYear)*365)+(as.integer(inMonth)*30)+(as.integer(inDay)))
  ) %>%
  select(!c(name, dob, inDay, inMonth, inYear, outDay, outMonth, outYear, RiskRecidScreeningDate, c_charge_desc)) %>%
  mutate(
    crimeType = str_extract(c_charge_degree,"[MF]")
  ) %>%
  filter(
    !is.na(crimeType)
  ) %>%
  select(!c(daysInJail,juvMisdemeanerCount,juvFelonyCount,juvOtherCount,c_charge_degree,race,sex,RiskViolenceDecileScore,crimeType,ageCat,days_b_screening_arrest,c_days_from_compas,RiskRecidScoreLevel,RiskViolenceScoreLevel))

mdf <- males %>%
  separate(c_jail_in, c("inDay","inMonth","inYear")) %>%
  separate(c_jail_out,c("outDay","outMonth","outYear")) %>%
  mutate(
    daysInJail = ((as.integer(outYear)*365)+(as.integer(outMonth)*30)+(as.integer(outDay)))-((as.integer(inYear)*365)+(as.integer(inMonth)*30)+(as.integer(inDay)))
  ) %>%
  select(!c(name, dob, inDay, inMonth, inYear, outDay, outMonth, outYear, RiskRecidScreeningDate, c_charge_desc)) %>%
  mutate(
    crimeType = str_extract(c_charge_degree,"[MF]")
  ) %>%
  filter(
    !is.na(crimeType)
  ) %>%
  select(!c(juvMisdemeanerCount,juvFelonyCount,juvOtherCount,c_charge_degree,race,sex,RiskViolenceDecileScore,crimeType,ageCat,days_b_screening_arrest,c_days_from_compas,RiskRecidScoreLevel,RiskViolenceScoreLevel))

fmodel <- glm(data=fdf,isRecid~.,family="binomial")

mmodel <- glm(data=mdf,isRecid~.,family="binomial")
```

### Model for females {.tabset}

#### Simple
|Variable|Value|
|:-|:-|
|Intercept|`r fmodel[[1]][1]`|
|Age|`r fmodel[[1]][2]`|
|Priors|`r fmodel[[1]][3]`|
|Risk Recid Score|`r fmodel[[1]][4]`|

#### Full Summary
```{r}
summary(fmodel)
```

#### Error
```{r}
fmodelPred <- predict.glm(fmodel,newdata=fdf,type="response")


fDataPred  <- cbind(fdf,fmodelPred)

fDataPred <- fDataPred %>%
  mutate(
    recidPred = ifelse(fmodelPred > .5, 1, 0)
  )

fmatrix <- table(fDataPred$recidPred,fDataPred$isRecid)
```

|||||
|-|-|-|-|
|||Predicted|Predicted|
|||Didn't Reoffend|Reoffended|
|Actual|Didn't Reoffend|`r fmatrix[1]`|`r fmatrix[3]`|
|Actual|Reoffended|`r fmatrix[2]`|`r fmatrix[4]`|

Error rate: &emsp; `r ((fmatrix[1,2]+fmatrix[2,1])/count(fdf))`

Null hypothesis error: &emsp; `r (table(fdf$isRecid)[2]/count(fdf))`

#### Equation
WIP

### {-}


### Model for males {.tabset}

#### Simple
|Variable|Value|
|:-|:-|
|Intercept|`r mmodel[[1]][1]`|
|Age|`r mmodel[[1]][2]`|
|Priors|`r mmodel[[1]][3]`|
|Risk Recid Score|`r mmodel[[1]][4]`|
|Days in Jail|`r mmodel[[1]][4]`|

#### Full Summary
```{r}
summary(mmodel)
```

#### Error
```{r}
mmodelPred <- predict.glm(mmodel,newdata=mdf,type="response")


mDataPred  <- cbind(mdf,mmodelPred)

mDataPred <- mDataPred %>%
  mutate(
    recidPred = ifelse(mmodelPred > .5, 1, 0)
  )

mmatrix <- table(mDataPred$recidPred,mDataPred$isRecid)
```

|||||
|-|-|-|-|
|||Predicted|Predicted|
|||Didn't Reoffend|Reoffended|
|Actual|Didn't Reoffend|`r mmatrix[1]`|`r mmatrix[3]`|
|Actual|Reoffended|`r mmatrix[2]`|`r mmatrix[4]`|

Error rate: &emsp; `r ((mmatrix[1,2]+mmatrix[2,1])/count(mdf))`

Null hypothesis error: &emsp; `r (table(mdf$isRecid)[2]/count(mdf))`

#### Equation
WIP

### {-}



As we can see from the two summaries, there was more variables that had a significant effect on the recidivism for males than for females. This may be because of the smaller population of females making it harder to predict and see trends in the data. Overall we can see that our prediction for males is much more accurate than our prediction for females. This may be due to several factors, but the lack of female data in comparison to male data is most likely the leading contributer of this descrepency.

# Another story about criminal justice

In our data set we were given date of birth for each individual. We wondered if there was anything to astrology, so we engineered a column for the birth signs for each criminal. Below are some plots we made with this data.

```{r}
library(arules)


extraData <- Originaldata %>%
  separate(c_jail_in, c("inDay","inMonth","inYear")) %>%
  separate(c_jail_out,c("outDay","outMonth","outYear")) %>%
  mutate(
    daysInJail = ((as.integer(outYear)*365)+(as.integer(outMonth)*30)+(as.integer(outDay)))-((as.integer(inYear)*365)+(as.integer(inMonth)*30)+(as.integer(inDay)))
  ) %>%
  select(!c(name, inDay, inMonth, inYear, outDay, outMonth, outYear, RiskRecidScreeningDate, c_charge_desc)) %>%
  mutate(
    crimeType = str_extract(c_charge_degree,"[MF]")
  ) %>%
  filter(
    !is.na(crimeType)
  ) %>%
  separate(dob, c("birthDay","birthMonth")) %>%
  mutate(
    birthMonth = as.integer(str_remove(birthMonth,"^0+")),
    birthDay = as.integer(birthDay)
  ) %>%
  mutate(
    birthSign = case_when(
      (birthMonth == 1 & birthDay > 19) | (birthMonth == 2 & birthDay < 19) ~ "Aquarius",
      (birthMonth == 2 & birthDay > 18) | (birthMonth == 3 & birthDay < 21) ~ "Pisces",
      (birthMonth == 3 & birthDay > 20) | (birthMonth == 4 & birthDay < 20) ~ "Aries",
      (birthMonth == 4 & birthDay > 19) | (birthMonth == 5 & birthDay < 21) ~ "Taurus",
      (birthMonth == 5 & birthDay > 20) | (birthMonth == 6 & birthDay < 21) ~ "Gemini",
      (birthMonth == 6 & birthDay > 21) | (birthMonth == 7 & birthDay < 23) ~ "Cancer",
      (birthMonth == 7 & birthDay > 22) | (birthMonth == 8 & birthDay < 23) ~ "Leo",
      (birthMonth == 8 & birthDay > 22) | (birthMonth == 9 & birthDay < 23) ~ "Virgo",
      (birthMonth == 9 & birthDay > 22) | (birthMonth == 10 & birthDay < 23) ~ "Libra",
      (birthMonth == 10 & birthDay > 22) | (birthMonth == 11 & birthDay < 22) ~ "Scorpius",
      (birthMonth == 11 & birthDay > 21) | (birthMonth == 12 & birthDay < 22) ~ "Sagittarius",
      (birthMonth == 12 & birthDay > 21) | (birthMonth == 1 & birthDay < 20) ~ "Capricorn"
    )) %>%
  select(!c(birthDay, birthMonth, crimeType,c_charge_degree,ageCat,days_b_screening_arrest,c_days_from_compas,RiskRecidScoreLevel,RiskViolenceScoreLevel)) %>%
  filter(!is.na(birthSign))
```

We will also be exploring race in the Broward County data set. We are wondering how much race effects the risk recidiviation score and how the imbalance of race in the database could make a model biased.