---
title: "DS325 Project 3: Recidivism"
author: "Johnny Carstens & Matthew Bushnell"
date: "12/2/2021"
output:
  html_document:
    theme: spacelab
    highlight: haddock
    toc: true
    toc_float: true
    number_sections: false
    code_folding: hide
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=TRUE, message=FALSE, warning=FALSE)
```


# Introduction
For this project, we are analyzing a criminal justice data set to accurately model and predict recidivism (the likelihood a criminal will reoffend). The data set we are using for these models is from Broward County, Florida and also contains recidivity risk and violence risk scores from a test that the criminals were given. We will build a model with and a model without those scores to determine how helpful the tests really are in predicting recidivity. 

Not only will we be creating models on our data set to predict recidivity, we will also be exploring the implications and morality of using algorithms in the criminal justice system. We will also be exploring some additional questions aside from recidivism for this data set. 

# Data Cleaning

The data set we were given is exceptionally messy. There are multiple fields that are not useful (date of birth being one) and others that are inusable in their current state (jail in, jail out). The first thing we did was turn jail in and jail out from dates into one column that calculated total days spent in jail. Then we get rid of name and dob. After that we got rid of other variables based upon our needs for the specific models we were created.

# Logistic Regression of Recidivism Data

```{r trapAnthem}
library(tidyverse)
library(olsrr)
library(ggfortify)
library(GGally)
library(mdsr)
data <- read.csv("Project3Sample4000.csv")

pairs <- data %>% select(!c(name,dob, c_jail_in, c_jail_out, RiskRecidScreeningDate,c_charge_desc))

Originaldata <- read.csv("Project3Sample4000.csv")

############### Matt's code
data <- Originaldata %>%
  separate(c_jail_in, c("inDay","inMonth","inYear")) %>%
  separate(c_jail_out,c("outDay","outMonth","outYear")) %>%
  mutate(
    daysInJail = ((as.integer(outYear)*365)+(as.integer(outMonth)*30)+(as.integer(outDay)))-((as.integer(inYear)*365)+(as.integer(inMonth)*30)+(as.integer(inDay)))
  ) %>%
  select(!c(name, dob, inDay, inMonth, inYear, outDay, outMonth, outYear, RiskRecidScreeningDate, c_charge_desc)) %>%
  mutate(
    crimeType = str_extract(c_charge_degree,"[MF]")
  ) %>%
  filter(
    !is.na(crimeType)
  ) %>%
  select(!c(RiskViolenceDecileScore,crimeType,c_charge_degree,race,juvFelonyCount,juvMisdemeanerCount,juvOtherCount,ageCat,days_b_screening_arrest,c_days_from_compas,RiskRecidScoreLevel,RiskViolenceScoreLevel))


ggplot(pairs, aes(x = age, fill = as.factor(isRecid))) + 
  geom_density(alpha=.3) + 
  labs(x = "Age", y = "Density", title = "Figure 1: Density of Age", fill="Reoffended")
```

Figure 1 is a density plot of Age vs Reoffenders. Reoffend is a binary response variable where 1 is equal to a person who did reoffend, and 0 is equal to someone who hasn't reoffended. Notice that in Figure 1, as age increases the amount of people who reoffended, or didn't reoffend decreases. We can also see that between ages 30 and 35, the amount of people who didn't recidivate becomes greater than those who did recidivate. It makes sense to see older individuals become less inclined towards reoffending while younger individuals have a greater inclination towards reoffending. Perhaps one of the reasons why older individuals are less inclined to reoffending is because of extensive time spent in incarceration. Age looks like a good variable to use in our model.

```{r jPop}
ggplot(pairs, aes(x=priorsCount, fill=as.factor(isRecid))) + 
  geom_density(alpha=.3) + 
  labs(x="Number of Prior Convictions", y = "Density", title = "Figure 2: Density of Prior Convictions.", fill = "Reoffended")
```

Figure 2 is a density plot of the number of prior convictions who did and did not recidivate. It is clear that those who have never committed a prior crime are much less likely to reoffend. This data is fairly skewed, so we apply the natural log function to the number of prior convictions which brings us to the next plot. 

```{r Dragostea Din Tei}
ggplot(pairs, aes(x=log(priorsCount+0.1), fill=as.factor(isRecid))) + 
  geom_density(alpha=.3) + 
  labs(x="Logarithm of Prior Convictions", y = "Density", title = "Figure 3: Density of ln(Prior Convictions)", fill = "Reoffended")
```

Figure 3 is the same plot as figure 2, except we added 0.1 to the number of prior convictions and then applied a natural logarithm to the data column. We can see that the distribution has been normalized better compared to Figure 2. We shall use this process of using the natural logarithm when building our logistic regression model. The peak on the left side of the data represents individuals who had 0 prior convictions while the next bump over the valley represents those who had 1 or more. The reason for the valley in between is because of the nature of logarithms and the fact that we had to add 0.1 to the values of 0 in order to get defined numbers. We can see that individuals who had 1 prior were slightly less likely to reoffend while those with more than 1 greatly increased their recidivity risk.

```{r I cant remember if we wanted to include this one}
ggplot(pairs, aes(x=sex, fill = as.factor(isRecid))) + geom_bar(position = "dodge") + 
  labs(x = "Sex", y = "Count", title = "Figure 4: isRecid vs Sex",fill="Reoffended")
```

Figure 4 is a bar graph of Sex vs Reoffended. First we note that the male category is much larger. This plot also shows that less than a third of females are likely to reoffend while greater than a third of men are likely to reoffend. This information can be useful to our model.

```{r}
ggplot(data=data,aes(x=daysInJail,fill=as.factor(isRecid))) +
  geom_density(alpha=.3) +
  labs(x="Days spent in jail",y="Density",fill="Reoffended",title="Figure 5: Density of days spent in jail") +
  xlim(0,25)
```

Figure 5 is a density plot of the logarithm of days spent in jail colored by those who reoffended and those who did not. We can see that those who have only spent one day in jail are much less likely to reoffend than those who have spent more. This is a good indicator that days spent in jail can be used to predict recedivism.


# Building Logistic Regession Models for Classification
The data set provided contained a variable called RiskRecidDecileScore. This score came from convicts taking a test that determined how likey they are to recidivate on a scale of 1-10. We built one model that includes the RiskRecidDecileScore and one model without the score. 
The first model we built does not include RiskRecidDecileScore in our prediction variables. 

```{r Metallica, results='fold'}
modelNSdata <- data %>% select(!RiskRecidDecileScore)
modelNS <- glm(data=modelNSdata,isRecid~sex+age+daysInJail+log(priorsCount+.1),family="binomial")
```

### Model with no scores{.tabset}
#### Simple

|Variable|Value|
|:-|:-|
|Intercept|`r modelNS[[1]][1]`|
|Sex=Male|`r modelNS[[1]][2]`|
|Age|`r modelNS[[1]][3]`|
|Days In Jail|`r modelNS[[1]][4]`|
|Natural Log of Priors|`r modelNS[[1]][5]`|

#### Full Summary
```{r}
summary(modelNS)
```

#### Error
```{r matt is being confusing}
modelNSPred <- predict.glm(modelNS,newdata=data,type="response")


dataWNSPred  <- cbind(data,modelNSPred)

dataWNSPred <- dataWNSPred %>%
  mutate(
    recidPred = ifelse(modelNSPred > .5, 1, 0)
  )

WNSmatrix <- table(dataWNSPred$recidPred,dataWNSPred$isRecid)
```

|||||
|-|-|-|-|
|||Predicted|Predicted|
|||Didn't Reoffend|Reoffended|
|Actual|Didn't Reoffend|`r WNSmatrix[1]`|`r WNSmatrix[3]`|
|Actual|Reoffended|`r WNSmatrix[2]`|`r WNSmatrix[4]`|

$$ 
\textrm{Error Rate} = \frac{CF_{12} + CF_{21}}{n},\textrm{ where i = row, j = column, and n = number of observations.}
$$ 

Using our Error Rate formula and plugging in values from our confusion matrix gives us 
$$
\textrm{Error Rate} = 0.2958979	
$$

#### Equation
<!-- equation here -->


### {-}

**---------------------------------------------------------------------------**

Above is a summary of the logistic model created to predict whether or not a convict will recidivate. If we check the full summery tab we can see that all of our variables are statistically significant. 

<!-- Johnny can you explain the equation here-->

The error tab above shows our confusion matrix for our logistic model. The first row is the actual number of convicts who didn't recidivate who were predicted to either recidivate or not recidivate. For example, the top left of the matrix is the number of actual convicts who did not recidivate who were predicted to not recidivate, and the top right is the number of convicts who didn't recidivate who were predicted to recidivate. The bottom row is similar except its the number of people who did recidvate and the number of convicts who were predicited to either not recidivate or predicited to recidivate. From this matrix we can calculate our error rate. Error rate is defined as the number of people who didn't recidivate who were predicted to recidivate plus the number of people who did recidivate who were predicted to not recidivate dived by the total number of observations. The mathematical definition is 

Our error rate is the percentage of data points that our model got wrong.

Now we will build a model using the recidivism scores that we were given with the data set. This will help determine if the scores are effective or not.

```{r}
modelWS <- glm(data=data,isRecid~+sex+age+RiskRecidDecileScore+daysInJail+log(priorsCount+.1),family="binomial")

modelWSPred <- predict.glm(modelWS,newdata=data,type="response")


dataWSPred  <- cbind(data,modelWSPred)

dataWSPred <- dataWSPred %>%
  mutate(
    recidPred = ifelse(modelWSPred > .5, 1, 0)
  )

WSmatrix <- table(dataWSPred$recidPred,dataWSPred$isRecid)
```

### Model with scores{.tabset}
#### Simple

|Variable|Value|
|:-|:-|
|Intercept|`r modelWS[[1]][1]`|
|Sex=Male|`r modelWS[[1]][2]`|
|Age|`r modelWS[[1]][3]`|
|Risk Recid Decile Score|`r modelWS[[1]][4]`|
|Days In Jail|`r modelWS[[1]][5]`|
|Natural Log of Priors|`r modelWS[[1]][6]`|

#### Full Summary
```{r}
summary(modelWS)
```

#### Error
|||||
|-|-|-|-|
|||Predicted|Predicted|
|||Didn't Reoffend|Reoffended|
|Actual|Didn't Reoffend|`r WSmatrix[1]`|`r WSmatrix[3]`|
|Actual|Reoffended|`r WSmatrix[2]`|`r WSmatrix[4]`|

#### Equation
<!-- equation here  -->

### {-}

**---------------------------------------------------------------------------**

Above is a summary of the logistic model created to predict whether or not a convict will recidivate. If we check the full summery tab we can see that all of our variables are statistically significant. We also have the error tab ----

<!-- Johnny explain equation here because I can't -->

# Multiple Regression Models

In this section we are trying to predict the scores for recidivism that the convicts received from their test. These scores range from 1-10 for recidivism risk and violence risk.

### Model for Predicting Recedivism Risk {.tabset}

#### Simple
```{r}
bestModel <- lm(RiskRecidDecileScore ~ age + race + juvFelonyCount + juvOtherCount + priorsCount, data=Originaldata)
```

|Variable|Value|
|:-|:-|
|Intercept|`r bestModel[[1]][1]`|
|Age|`r bestModel[[1]][2]`|
|Race=Hispanic|`r bestModel[[1]][3]`|
|Race=Other|`r bestModel[[1]][4]`|
|Race=White|`r bestModel[[1]][5]`|
|Juvenile Felony Count|`r bestModel[[1]][6]`|
|Juvenile Other Count|`r bestModel[[1]][7]`|
|Priors Count|`r bestModel[[1]][8]`|

#### Full Summery
```{r}
summary(bestModel)
```

#### Error
<!-- error -->

#### Equation
<!-- equation -->

### {-}

**---------------------------------------------------------------------------**

<!-- explanation for model -->

### Model for Predicting Violence Risk {.tabset}

#### Simple
```{r}
pleaseGodHelp <- Originaldata %>% 
  select(!c(c_charge_degree,c_charge_desc,name,dob,RiskRecidScreeningDate,c_jail_in,c_jail_out,RiskViolenceScoreLevel, isRecid, ageCat, RiskRecidScoreLevel, RiskRecidDecileScore, RiskViolenceScoreLevel, c_days_from_compas, days_b_screening_arrest))

byron <- lm(RiskViolenceDecileScore ~ ., pleaseGodHelp)
```

|Variable|Value|
|:-|:-|
|Intercept|`r byron[[1]][1]`|
|Sex=Male|`r byron[[1]][2]`|
|Age|`r byron[[1]][3]`|
|Race=Hispanic|`r byron[[1]][4]`|
|Race=Other|`r byron[[1]][5]`|
|Race=White|`r byron[[1]][6]`|
|Juvenile Felony Count|`r byron[[1]][7]`|
|Juvenile Misdemeaner Count|`r byron[[1]][8]`|
|Juvenile Other Count|`r byron[[1]][9]`|
|Priors Count|`r byron[[1]][10]`|

#### Full Summery
```{r}
summary(byron)
```


#### Error

#### Equation

### {-}

**---------------------------------------------------------------------------**

# Classification models for two subpopulations.

Looking at our data from Broward County we can see that there is a much larger amount of males when compared to females. Let us make a classification model for each gender and see how they compare to each other.

```{r}
males <- read.csv("Project3Males1500.csv")
females <- read.csv("Project3Females1500.csv")

fdf <- females %>%
  separate(c_jail_in, c("inDay","inMonth","inYear")) %>%
  separate(c_jail_out,c("outDay","outMonth","outYear")) %>%
  mutate(
    daysInJail = ((as.integer(outYear)*365)+(as.integer(outMonth)*30)+(as.integer(outDay)))-((as.integer(inYear)*365)+(as.integer(inMonth)*30)+(as.integer(inDay)))
  ) %>%
  select(!c(name, dob, inDay, inMonth, inYear, outDay, outMonth, outYear, RiskRecidScreeningDate, c_charge_desc)) %>%
  mutate(
    crimeType = str_extract(c_charge_degree,"[MF]")
  ) %>%
  filter(
    !is.na(crimeType)
  ) %>%
  select(!c(daysInJail,juvMisdemeanerCount,juvFelonyCount,juvOtherCount,c_charge_degree,race,sex,RiskViolenceDecileScore,crimeType,ageCat,days_b_screening_arrest,c_days_from_compas,RiskRecidScoreLevel,RiskViolenceScoreLevel))

mdf <- males %>%
  separate(c_jail_in, c("inDay","inMonth","inYear")) %>%
  separate(c_jail_out,c("outDay","outMonth","outYear")) %>%
  mutate(
    daysInJail = ((as.integer(outYear)*365)+(as.integer(outMonth)*30)+(as.integer(outDay)))-((as.integer(inYear)*365)+(as.integer(inMonth)*30)+(as.integer(inDay)))
  ) %>%
  select(!c(name, dob, inDay, inMonth, inYear, outDay, outMonth, outYear, RiskRecidScreeningDate, c_charge_desc)) %>%
  mutate(
    crimeType = str_extract(c_charge_degree,"[MF]")
  ) %>%
  filter(
    !is.na(crimeType)
  ) %>%
  select(!c(juvMisdemeanerCount,juvFelonyCount,juvOtherCount,c_charge_degree,race,sex,RiskViolenceDecileScore,crimeType,ageCat,days_b_screening_arrest,c_days_from_compas,RiskRecidScoreLevel,RiskViolenceScoreLevel))

fmodel <- glm(data=fdf,isRecid~.,family="binomial")

mmodel <- glm(data=mdf,isRecid~.,family="binomial")
```

### Model for females {.tabset}

#### Simple
|Variable|Value|
|:-|:-|
|Intercept|`r fmodel[[1]][1]`|
|Age|`r fmodel[[1]][2]`|
|Priors|`r fmodel[[1]][3]`|
|Risk Recid Score|`r fmodel[[1]][4]`|

#### Full Summary
```{r}
summary(fmodel)
```

#### Error
```{r}
fmodelPred <- predict.glm(fmodel,newdata=fdf,type="response")


fDataPred  <- cbind(fdf,fmodelPred)

fDataPred <- fDataPred %>%
  mutate(
    recidPred = ifelse(fmodelPred > .5, 1, 0)
  )

fmatrix <- table(fDataPred$recidPred,fDataPred$isRecid)
```

|||||
|-|-|-|-|
|||Predicted|Predicted|
|||Didn't Reoffend|Reoffended|
|Actual|Didn't Reoffend|`r fmatrix[1]`|`r fmatrix[3]`|
|Actual|Reoffended|`r fmatrix[2]`|`r fmatrix[4]`|

Error rate: &emsp; `r ((fmatrix[1,2]+fmatrix[2,1])/count(fdf))`

Null hypothesis error: &emsp; `r (table(fdf$isRecid)[2]/count(fdf))`

#### Equation
WIP

### {-}

**---------------------------------------------------------------------------**

### Model for males {.tabset}

#### Simple
|Variable|Value|
|:-|:-|
|Intercept|`r mmodel[[1]][1]`|
|Age|`r mmodel[[1]][2]`|
|Priors|`r mmodel[[1]][3]`|
|Risk Recid Score|`r mmodel[[1]][4]`|
|Days in Jail|`r mmodel[[1]][4]`|

#### Full Summary
```{r}
summary(mmodel)
```

#### Error
```{r}
mmodelPred <- predict.glm(mmodel,newdata=mdf,type="response")


mDataPred  <- cbind(mdf,mmodelPred)

mDataPred <- mDataPred %>%
  mutate(
    recidPred = ifelse(mmodelPred > .5, 1, 0)
  )

mmatrix <- table(mDataPred$recidPred,mDataPred$isRecid)
```

|||||
|-|-|-|-|
|||Predicted|Predicted|
|||Didn't Reoffend|Reoffended|
|Actual|Didn't Reoffend|`r mmatrix[1]`|`r mmatrix[3]`|
|Actual|Reoffended|`r mmatrix[2]`|`r mmatrix[4]`|

Error rate: &emsp; `r ((mmatrix[1,2]+mmatrix[2,1])/count(mdf))`

Null hypothesis error: &emsp; `r (table(mdf$isRecid)[2]/count(mdf))`

#### Equation
WIP

### {-}

**---------------------------------------------------------------------------**

As we can see from the two summaries, there was more variables that had a significant effect on the recidivism for males than for females. This may be because of the smaller population of females making it harder to predict and see trends in the data. Overall we can see that our prediction for males is much more accurate than our prediction for females. This may be due to several factors, but the lack of female data in comparison to male data is most likely the leading contributer of this descrepency.

# Another story about criminal justice

In our data set we were given date of birth for each individual. We wondered if there was anything to astrology, so we engineered a column for the birth signs for each criminal. Below are some plots we made with this data.

```{r}
library(arules)


extraData <- Originaldata %>%
  separate(c_jail_in, c("inDay","inMonth","inYear")) %>%
  separate(c_jail_out,c("outDay","outMonth","outYear")) %>%
  mutate(
    daysInJail = ((as.integer(outYear)*365)+(as.integer(outMonth)*30)+(as.integer(outDay)))-((as.integer(inYear)*365)+(as.integer(inMonth)*30)+(as.integer(inDay)))
  ) %>%
  select(!c(name, inDay, inMonth, inYear, outDay, outMonth, outYear, RiskRecidScreeningDate, c_charge_desc)) %>%
  mutate(
    crimeType = str_extract(c_charge_degree,"[MF]")
  ) %>%
  filter(
    !is.na(crimeType)
  ) %>%
  separate(dob, c("birthDay","birthMonth")) %>%
  mutate(
    birthMonth = as.integer(str_remove(birthMonth,"^0+")),
    birthDay = as.integer(birthDay)
  ) %>%
  mutate(
    birthSign = case_when(
      (birthMonth == 1 & birthDay > 19) | (birthMonth == 2 & birthDay < 19) ~ "Aquarius",
      (birthMonth == 2 & birthDay > 18) | (birthMonth == 3 & birthDay < 21) ~ "Pisces",
      (birthMonth == 3 & birthDay > 20) | (birthMonth == 4 & birthDay < 20) ~ "Aries",
      (birthMonth == 4 & birthDay > 19) | (birthMonth == 5 & birthDay < 21) ~ "Taurus",
      (birthMonth == 5 & birthDay > 20) | (birthMonth == 6 & birthDay < 21) ~ "Gemini",
      (birthMonth == 6 & birthDay > 21) | (birthMonth == 7 & birthDay < 23) ~ "Cancer",
      (birthMonth == 7 & birthDay > 22) | (birthMonth == 8 & birthDay < 23) ~ "Leo",
      (birthMonth == 8 & birthDay > 22) | (birthMonth == 9 & birthDay < 23) ~ "Virgo",
      (birthMonth == 9 & birthDay > 22) | (birthMonth == 10 & birthDay < 23) ~ "Libra",
      (birthMonth == 10 & birthDay > 22) | (birthMonth == 11 & birthDay < 22) ~ "Scorpius",
      (birthMonth == 11 & birthDay > 21) | (birthMonth == 12 & birthDay < 22) ~ "Sagittarius",
      (birthMonth == 12 & birthDay > 21) | (birthMonth == 1 & birthDay < 20) ~ "Capricorn"
    )) %>%
  select(!c(birthDay, birthMonth, crimeType,c_charge_degree,ageCat,days_b_screening_arrest,c_days_from_compas,RiskRecidScoreLevel,RiskViolenceScoreLevel)) %>%
  filter(!is.na(birthSign))
```

```{r}
ggplot(data=extraData,aes(x=birthSign, fill=as.factor(isRecid))) +
  geom_bar(position="dodge") +
  labs(title="Count of Birthsign and Reoffended",x="Birth Sign",y="Count",fill="Reoffended") +
  theme(axis.text.x=element_text(angle =- 20,hjust=-.1))
```

The plot above shows the count of those who reoffended by their birth signs. As one would expect, there isn't any conclusive evidence that any of the birthsigns are more commonly criminal or more likely to recidivate. However, the plot below offers some more interesting insight.

```{r}
ggplot(data=extraData,aes(x=birthSign,y=juvFelonyCount+juvMisdemeanerCount,fill=as.factor(isRecid)))+
  geom_col() +
  labs(fill="Reoffended", title="Juvenile Felony+Misdemeaner Count vs. Birth Sign", x="Birth Sign", y="Juvenile Felony+Misdemeaner Count") +
  theme(axis.text.x=element_text(angle =- 20,hjust=-.1))
```

In the plot above we see that saggitarius and taurus are over represented for juvenile felonies and misdemeaners. When we built a model to predict juvenile felonies the P-value for taurus was < .02, meaning it was considered a significant factor for figuring juvenile felonies.

At first glance that might be a pretty poor factor to include in a model. However, there is an OECD study that suggests the month a child is born in has a factor in the success of a child in school. While we can confidently say a child's birth sign doesn't immediately affect their chances of being criminal, what month a child is born in shouldn't be discounted. Education and success in school is related to chances of criminal activity. When we make a model off of human behavior it can be hard to predict what is and isn't significant. On one hand we could have tried to give credit to astrology to predict juvenile felonies. On the other hand we could have completely discredited birth month when it has been proven to have an effect on students. Predicted human behavior can be difficult and the lines between what is ethical and unethical can be blurry. As data scientists we should be careful when we approach a problem that predicts human behavior.

# Works Cited

https://read.oecd-ilibrary.org/education/how-student-s-month-of-birth-is-linked-to-performance-at-school_822ea6ce-en#page20